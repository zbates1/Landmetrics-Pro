{% extends "base.html" %}

{% block title %}User Data Visualization{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center mb-5">User Data Visualization</h1>

    <!-- Device Selection -->
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <label for="deviceSelect" class="form-label">Select a Device</label>
            <select id="deviceSelect" class="form-select">
                <option value="" disabled selected>Select a Device</option>
                {% for device in devices %}
                    <option value="{{ device.id }}" {% if device.id == selected_device_id %}selected{% endif %}>
                        {{ device.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Timestamp Selection -->
    {% if selected_device_id %}
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <label for="timestampSelect" class="form-label">Select a Timestamp</label>
            <select id="timestampSelect" class="form-select">
                <option value="all" selected>All Timestamps</option>
                {% for timestamp in device_data[selected_device_id]['timestamps'] %}
                    <option value="{{ loop.index0 }}">{{ timestamp }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    {% endif %}

    <!-- Chart Type Selection -->
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <label for="chartTypeSelect" class="form-label">Select Chart Type</label>
            <select id="chartTypeSelect" class="form-select">
                <option value="line" selected>Line Chart</option>
                <!-- Additional chart types can be added here -->
            </select>
        </div>
    </div>

    <!-- Chart Area -->
    <div class="row">
        <div class="col-md-12">
            <canvas id="dataChart" style="max-height: 500px;"></canvas>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Data passed from the server
    const deviceData = {{ device_data | tojson }};
    const selectedDeviceId = {{ selected_device_id | tojson }};

    document.addEventListener('DOMContentLoaded', function() {
        const deviceSelect = document.getElementById('deviceSelect');
        const timestampSelect = document.getElementById('timestampSelect');
        const chartTypeSelect = document.getElementById('chartTypeSelect');
        const ctx = document.getElementById('dataChart').getContext('2d');

        let chart;

        deviceSelect.addEventListener('change', function() {
            const deviceId = deviceSelect.value;
            if (deviceId) {
                // Redirect to the same page with the selected device ID
                window.location.href = "{{ url_for('data_view.user_data') }}?device_id=" + deviceId;
            }
        });

        if (timestampSelect) {
            timestampSelect.addEventListener('change', updateChart);
        }

        if (chartTypeSelect) {
            chartTypeSelect.addEventListener('change', updateChart);
        }

        function updateChart() {
            const data = deviceData[selectedDeviceId];
            if (!data) return;

            const selectedTimestampIndex = timestampSelect ? timestampSelect.value : 'all';
            const chartType = chartTypeSelect.value;

            let labels = [];
            let datasets = [];

            // List of sensor variables
            const variables = ['ax1', 'ay1', 'az1', 'gx1', 'gy1', 'gz1',
                               'ax2', 'ay2', 'az2', 'gx2', 'gy2', 'gz2',
                               'ax3', 'ay3', 'az3', 'gx3', 'gy3', 'gz3'];

            const colors = [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(199, 199, 199, 0.6)',
                'rgba(83, 102, 255, 0.6)',
                'rgba(83, 255, 126, 0.6)',
                'rgba(255, 83, 183, 0.6)',
                'rgba(255, 234, 83, 0.6)',
                'rgba(83, 255, 234, 0.6)',
                'rgba(83, 255, 83, 0.6)',
                'rgba(255, 83, 83, 0.6)',
                'rgba(83, 83, 255, 0.6)',
                'rgba(255, 83, 255, 0.6)',
                'rgba(83, 83, 83, 0.6)',
                'rgba(255, 255, 83, 0.6)'
            ];

            if (selectedTimestampIndex === 'all') {
                // Plot all data against time
                labels = data['timestamps'];

                variables.forEach((variable, index) => {
                    datasets.push({
                        label: variable,
                        data: data[variable],
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length],
                        fill: false
                    });
                });

            } else {
                // Plot data for a single timestamp
                const index = parseInt(selectedTimestampIndex);
                labels = [data['timestamps'][index]];

                variables.forEach((variable, idx) => {
                    datasets.push({
                        label: variable,
                        data: [data[variable][index]],
                        backgroundColor: colors[idx % colors.length]
                    });
                });
            }

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Sensor Values'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Initial chart rendering
        if (selectedDeviceId && timestampSelect) {
            updateChart();
        }
    });
</script>
{% endblock %}
