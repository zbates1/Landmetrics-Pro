{% extends "base.html" %}

{% block title %}Landmetrics Pro Data Visualization{% endblock %}

{% block content %}
<div class="container my-5">
    <style>
        body {
            margin: 0;
            background: linear-gradient(to bottom, #f0f0f0, #a3ceac);
        }
    </style>

    <h1 class="text-center mb-5">Landmetrics Pro - Data Visualization</h1>

    <!-- Device Selection Section -->
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <label for="deviceSelect" class="form-label">Select a Device</label>
            <select id="deviceSelect" class="form-select form-select-lg mb-3" onchange="onDeviceChange()">
                <option value="" disabled selected>Select a Device</option>
                {% for device in devices %}
                    <option value="{{ device.id }}" {% if device.id == selected_device_id %}selected{% endif %}>{{ device.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Data Selection Section -->
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <label for="dataSelect" class="form-label">Select Data to Display</label>
            <select id="dataSelect" class="form-select form-select-lg mb-3" onchange="updateGraph()">
                <option value="acceleration">Acceleration (ax, ay, az)</option>
                <option value="gyroscope">Gyroscope (gx, gy, gz)</option>
            </select>
        </div>
    </div>

    <!-- Graph Type Selection -->
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <label for="graphType" class="form-label">Select Graph Type</label>
            <select id="graphType" class="form-select form-select-lg mb-3" onchange="updateGraph()">
                <option value="line">Line Chart</option>
                <option value="bar">Bar Chart</option>
            </select>
        </div>
    </div>

    <!-- Chart Area -->
    <div class="row mb-5">
        <div class="col-md-10 mx-auto">
            <div class="chart-container" style="position: relative; height: 60vh; width: 100%;">
                <canvas id="userDataChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Download Buttons -->
    <div class="row text-center mb-5">
        <div class="col-md-6">
            <button id="downloadGraph" class="btn btn-primary btn-lg">Download Graph</button>
        </div>
        <div class="col-md-6">
            <button id="downloadData" class="btn btn-secondary btn-lg">Download Data</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    {% if selected_device_id %}
      updateGraph(); // Initializes the graph if a device is selected
    {% endif %}
  });

  function onDeviceChange() {
    const deviceId = document.getElementById('deviceSelect').value;
    if (deviceId) {
      // Redirect to the same page with the selected device ID as a query parameter
      window.location.href = `{{ url_for('data_view.user_data') }}?device_id=${deviceId}`;
    }
  }

  function updateGraph() {
    const ctx = document.getElementById('userDataChart').getContext('2d');
    const graphType = document.getElementById('graphType').value;
    const dataType = document.getElementById('dataSelect').value;

    // Prepare datasets based on selected data type
    let datasets = [];
    if (dataType === 'acceleration') {
      datasets = [
        {
          label: 'ax',
          data: {{ ax_array | tojson }},
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.5)',
          tension: 0.1,
          fill: false
        },
        {
          label: 'ay',
          data: {{ ay_array | tojson }},
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          tension: 0.1,
          fill: false
        },
        {
          label: 'az',
          data: {{ az_array | tojson }},
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.5)',
          tension: 0.1,
          fill: false
        }
      ];
    } else if (dataType === 'gyroscope') {
      datasets = [
        {
          label: 'gx',
          data: {{ gx_array | tojson }},
          borderColor: 'rgb(153, 102, 255)',
          backgroundColor: 'rgba(153, 102, 255, 0.5)',
          tension: 0.1,
          fill: false
        },
        {
          label: 'gy',
          data: {{ gy_array | tojson }},
          borderColor: 'rgb(255, 159, 64)',
          backgroundColor: 'rgba(255, 159, 64, 0.5)',
          tension: 0.1,
          fill: false
        },
        {
          label: 'gz',
          data: {{ gz_array | tojson }},
          borderColor: 'rgb(255, 206, 86)',
          backgroundColor: 'rgba(255, 206, 86, 0.5)',
          tension: 0.1,
          fill: false
        }
      ];
    }

    const chartData = {
      labels: {{ labels | tojson }},
      datasets: datasets
    };

    // Clear existing canvas to redraw
    if (window.userDataChart && typeof window.userDataChart.destroy === 'function') {
        window.userDataChart.destroy();
    }

    window.userDataChart = new Chart(ctx, {
      type: graphType,
      data: chartData,
      options: {
        scales: {
          x: {
            type: 'time',
            time: {
              parser: 'YYYY-MM-DD HH:mm:ss',
              tooltipFormat: 'll HH:mm',
              unit: 'minute',
              displayFormats: {
                minute: 'HH:mm'
              }
            },
            title: {
              display: true,
              text: 'Timestamp'
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: dataType === 'acceleration' ? 'Acceleration (g)' : 'Angular Velocity (Â°/s)'
            }
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false,
          },
          zoom: {
            zoom: {
              wheel: {
                enabled: true,
              },
              mode: 'x',
            }
          }
        },
        interaction: {
          mode: 'index',
          intersect: false,
        }
      }
    });
  }
</script>

<!-- Download Graph -->
<script>
  document.getElementById('downloadGraph').addEventListener('click', function() {
    const url = window.userDataChart.toBase64Image();
    const link = document.createElement('a');
    link.download = 'userDataChart.png';
    link.href = url;
    link.click();
  });
</script>

<!-- Download Data -->
<script>
  document.getElementById('downloadData').addEventListener('click', function() {
    const data = {
      labels: {{ labels | tojson }},
      ax: {{ ax_array | tojson }},
      ay: {{ ay_array | tojson }},
      az: {{ az_array | tojson }},
      gx: {{ gx_array | tojson }},
      gy: {{ gy_array | tojson }},
      gz: {{ gz_array | tojson }}
    };
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
    const link = document.createElement('a');
    link.download = 'userData.json';
    link.href = dataStr;
    link.click();
  });
</script>

{% endblock %}
